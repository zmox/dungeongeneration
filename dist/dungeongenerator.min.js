/*! Dungeon Generator - v0.6.3 - 2014-05-30
* https://github.com/stefanweck/dungeongeneration
* Copyright (c) 2014 Stefan Weck */
function initializeCanvas(){var a=document.getElementById("canvas");a.width=window.innerWidth,a.height=window.innerHeight;{var b={canvas:a,cameraBounds:!1,debug:!1};new Roguelike.Game(b)}}var Roguelike=Roguelike||{VERSION:"0.6.3",Components:{},Systems:{}};Roguelike.Game=function(a){this.isInitialized=!1,this.map=null,this.mapFactory=null,this.mapDecorator=null,this.keyboard=null,this.scheduler=null,this.staticSystems={},this.dynamicSystems=[],this.camera=null,this.player=null,this.settings={canvas:null,cameraBounds:!1,debug:!1},this.settings=Roguelike.Utils.extend(this.settings,a),this.initialize()},Roguelike.Game.prototype={initialize:function(){if(!this.isInitialized){this.keyboard=new Roguelike.Keyboard,this.map=new Roguelike.Map(this),this.mapFactory=new Roguelike.MapFactory(this),this.mapDecorator=new Roguelike.MapDecorator(this),this.map.entities=new Roguelike.Group(this),this.scheduler=new Roguelike.Scheduler,this.mapFactory.generateRooms(),this.mapDecorator.decorateMap(),this.camera=new Roguelike.Camera(this,{x:0,y:0});var a=new Roguelike.Vector2(this.map.entrance.x,this.map.entrance.y),b={};b.left=65,b.right=68,b.up=87,b.down=83,this.player=Roguelike.PlayerFactory.newPlayerWarrior(this,a,b),this.map.entities.addEntity(this.player);var c=this.map.tiles[a.x][a.y];c.addEntity(this.player),this.scheduler.add(this.player,!0),this.camera.follow(this.player,this.settings.canvas.width/2,this.settings.canvas.height/2),this.staticSystems.movementSystem=new Roguelike.Systems.Movement(this),this.staticSystems.pathfindingSystem=new Roguelike.Systems.PathFinding(this),this.staticSystems.combatSystem=new Roguelike.Systems.Combat(this),this.staticSystems.openSystem=new Roguelike.Systems.Open(this),this.dynamicSystems.push(new Roguelike.Systems.LightMap(this)),this.dynamicSystems.push(new Roguelike.Systems.Render(this)),this.update(),this.isInitialized=!0}},update:function(){for(requestAnimationFrame(this.update.bind(this));!this.scheduler.lockCount;)this.scheduler.tick();for(var a=0;a<this.dynamicSystems.length;a++)this.dynamicSystems[a].update()}},Roguelike.Camera=function(a,b){this.game=a,this.position=b,this.viewportWidth=a.settings.canvas.width,this.viewportHeight=a.settings.canvas.height,this.minimumDistanceX=0,this.minimumDistanceY=0,this.followObject=null,this.viewportBoundary=new Roguelike.Boundary(this.position.x*a.map.settings.tileSize,this.position.y*a.map.settings.tileSize,this.viewportWidth,this.viewportHeight),this.mapBoundary=new Roguelike.Boundary(0,0,a.map.settings.tilesX*a.map.settings.tileSize,a.map.settings.tilesY*a.map.settings.tileSize)},Roguelike.Camera.prototype={follow:function(a,b,c){this.followObject=a.components.position,this.minimumDistanceX=b,this.minimumDistanceY=c},update:function(){if(null!==this.followObject){var a=this.game.map.settings.tileSize;this.followObject.position.x*a-this.position.x+this.minimumDistanceX>this.viewportWidth?this.position.x=this.followObject.position.x*a-(this.viewportWidth-this.minimumDistanceX):this.followObject.position.x*a-this.minimumDistanceX<this.position.x&&(this.position.x=this.followObject.position.x*a-this.minimumDistanceX),this.followObject.position.y*a-this.position.y+this.minimumDistanceY>this.viewportHeight?this.position.y=this.followObject.position.y*a-(this.viewportHeight-this.minimumDistanceY):this.followObject.position.y*a-this.minimumDistanceY<this.position.y&&(this.position.y=this.followObject.position.y*a-this.minimumDistanceY)}this.viewportBoundary.set(this.position.x,this.position.y),this.game.settings.cameraBounds&&!this.viewportBoundary.isWithin(this.mapBoundary)&&(this.viewportBoundary.left<this.mapBoundary.left&&(this.position.x=this.mapBoundary.left),this.viewportBoundary.top<this.mapBoundary.top&&(this.position.y=this.mapBoundary.top),this.viewportBoundary.right>this.mapBoundary.right&&(this.position.x=this.mapBoundary.right-this.viewportWidth),this.viewportBoundary.bottom>this.mapBoundary.bottom&&(this.position.y=this.mapBoundary.bottom-this.viewportHeight))}},Roguelike.Vector2=function(a,b){this.x=a,this.y=b},Roguelike.Vector2.prototype={combine:function(a){return new Roguelike.Vector2(this.x+a.x,this.y+a.y)},add:function(a){var b=a.x-this.x,c=a.y-this.y;return Math.abs(Math.sqrt(b*b+c*c))},distance:function(a){var b=a.x-this.x,c=a.y-this.y;return Math.abs(Math.sqrt(b*b+c*c))},manhattan:function(a){return Math.abs(this.x-a.x)+Math.abs(this.y-a.y)},clone:function(){return new Roguelike.Vector2(this.x,this.y)},toString:function(){return"("+this.x+", "+this.y+")"}},Roguelike.Boundary=function(a,b,c,d){this.left=a||0,this.top=b||0,this.width=c||0,this.height=d||0,this.right=this.left+this.width,this.bottom=this.top+this.height},Roguelike.Boundary.prototype={set:function(a,b,c,d){this.left=a,this.top=b,this.width=c||this.width,this.height=d||this.height,this.right=this.left+this.width,this.bottom=this.top+this.height},isWithin:function(a){return a.left<=this.left&&a.right>=this.right&&a.top<=this.top&&a.bottom>=this.bottom},isOverlapping:function(a){return this.left<a.right&&a.left<this.right&&this.top<a.bottom&&a.top<this.bottom}},Roguelike.Entity=function(a,b){this.game=a,this.speed=b||1e3,this.components={},this.onAddComponent=new Roguelike.Event,this.onRemoveComponent=new Roguelike.Event},Roguelike.Entity.prototype={act:function(){if(this.hasComponent("keyboardControl"))this.game.scheduler.lock();else{var a=this.getComponent("movement");a.execute()}},getSpeed:function(){return this.speed},hasComponent:function(a){return void 0!==this.components[a]},getComponent:function(a){return this.components[a]},addComponent:function(a){this.components[a.name]=a,this.onAddComponent.trigger(a)},removeComponent:function(a){this.components[a.name]=void 0,this.onRemoveComponent.trigger(a)}},Roguelike.Group=function(a){this.game=a,this.entities=[]},Roguelike.Group.prototype={addEntity:function(a){!a instanceof Roguelike.Entity||this.entities.push(a)},removeEntity:function(a){var b=Roguelike.Utils.contains(a,this.entities);-1!==b&&this.entities.splice(b,1)},getEntities:function(){for(var a=[],b=0;b<this.entities.length;b++){for(var c=[],d=0;d<arguments.length;d++)this.entities[b].components[arguments[d]]&&c.push(1);c.length===arguments.length&&a.push(this.entities[b])}return a}},Roguelike.Components.Sprite=function(a,b,c){this.name="sprite",this.sprite=a,this.row=b,this.tile=c},Roguelike.Components.Health=function(a){this.name="health",this.health=this.maxHealth=a},Roguelike.Components.Health.prototype={percentage:function(){return this.health/this.maxHealth},isDamaged:function(){return this.health<this.maxHealth},isDead:function(){return this.health<=0},takeDamage:function(a){this.health-=a}},Roguelike.Components.CanOpen=function(a,b){this.name="canOpen",this.game=a,this.entity=b,this.events=new Roguelike.Event,this.state="closed",this.initialize()},Roguelike.Components.CanOpen.prototype={initialize:function(){this.events.on("bumpInto",this.bumpInto,this)},bumpInto:function(){this.game.staticSystems.openSystem.handleSingleEntity(this.entity)}},Roguelike.Components.LightSource=function(a,b){this.name="lightSource",this.gradient=a,this.radius=b},Roguelike.Components.Collide=function(a){this.name="collide",this.collide=a},Roguelike.Components.KeyboardControl=function(a,b,c){this.name="keyboardControl",this.entity=b,this.game=a,this.controls=c,this.keyboard=a.keyboard,this.scheduler=a.scheduler,this.initialize()},Roguelike.Components.KeyboardControl.prototype={initialize:function(){for(var a in this.controls)switch(a){case"left":var b=this.keyboard.getKey(this.controls[a]);b.onDown.on(this.controls[a],this.newPosition.bind(this,"left"),this);break;case"right":var c=this.keyboard.getKey(this.controls[a]);c.onDown.on(this.controls[a],this.newPosition.bind(this,"right"),this);break;case"up":var d=this.keyboard.getKey(this.controls[a]);d.onDown.on(this.controls[a],this.newPosition.bind(this,"up"),this);break;case"down":var e=this.keyboard.getKey(this.controls[a]);e.onDown.on(this.controls[a],this.newPosition.bind(this,"down"),this)}},newPosition:function(a){var b;switch(a){case"left":b=new Roguelike.Vector2(-1,0);break;case"up":b=new Roguelike.Vector2(0,-1);break;case"right":b=new Roguelike.Vector2(1,0);break;case"down":b=new Roguelike.Vector2(0,1)}var c=this.entity.getComponent("position"),d=c.position.combine(b);this.game.staticSystems.movementSystem.handleSingleEntity(this.entity,d),this.scheduler.unlock()}},Roguelike.Components.Position=function(a){this.name="position",this.position=a},Roguelike.Components.Weapon=function(a){this.name="weapon",this.damage=a},Roguelike.Components.CanFight=function(a){this.name="canFight",this.game=a,this.events=new Roguelike.Event,this.initialize()},Roguelike.Components.CanFight.prototype={initialize:function(){this.events.on("bumpInto",this.bumpInto,this)},bumpInto:function(a,b){this.game.staticSystems.combatSystem.handleSingleEntity(a,b)}},Roguelike.Components.Movement=function(a,b,c){this.name="movement",this.game=a,this.entity=b,this.move=c},Roguelike.Components.Movement.prototype={execute:function(){this.move(this.game,this.entity)}},Roguelike.Systems.Render=function(a){this.game=a,this.canvas=null,this.context=null,this.mousePos=null,this.initialize()},Roguelike.Systems.Render.prototype={initialize:function(){this.canvas=this.game.settings.canvas,this.context=this.game.settings.canvas.getContext("2d"),this.canvas.addEventListener("mousemove",this.getMousePointer.bind(this)),this.context.mozImageSmoothingEnabled=!1,this.context.webkitImageSmoothingEnabled=!1,this.context.msImageSmoothingEnabled=!1,this.context.imageSmoothingEnabled=!1},update:function(){this.game.camera.update(),this.clear(),this.drawMap();var a=this.game.map.entities.getEntities("position","sprite");this.context.save();for(var b=0;b<a.length;b++)this.handleSingleEntity(a[b]);this.context.restore(),this.drawLightMap(),this.drawUI()},handleSingleEntity:function(a){var b=this.game.map,c=this.game.camera,d=a.getComponent("sprite"),e=a.getComponent("position"),f=document.getElementById(d.sprite);if(this.context.drawImage(f,16*d.tile,16*d.row,16,16,e.position.x*b.settings.tileSize-c.position.x,e.position.y*b.settings.tileSize-c.position.y,b.settings.tileSize,b.settings.tileSize),a.hasComponent("health")){var g=a.getComponent("health");g.isDamaged()&&(this.context.fillStyle="red",this.context.fillRect(e.position.x*this.game.map.settings.tileSize-this.game.camera.position.x,e.position.y*this.game.map.settings.tileSize-this.game.camera.position.y,this.game.map.settings.tileSize*g.percentage(),5))}},drawMap:function(){var a=this.game.map,b=this.game.camera,c=document.getElementById("tileset");this.context.save();for(var d=0;d<a.settings.tilesX;d++)for(var e=0;e<a.settings.tilesY;e++){var f=a.tiles[d][e].tileRow,g=a.tiles[d][e].tileNumber;this.context.drawImage(c,16*g,16*f,16,16,d*a.settings.tileSize-Math.round(b.position.x),e*a.settings.tileSize-Math.round(b.position.y),a.settings.tileSize,a.settings.tileSize)}this.context.restore()},drawLightMap:function(){var a=this.game.map,b=this.game.camera;this.context.save();for(var c=0;c<a.settings.tilesX;c++)for(var d=0;d<a.settings.tilesY;d++)this.context.fillStyle=a.tiles[c][d].explored===!0&&1-a.tiles[c][d].lightLevel>.7?"rgba(0, 0, 0, 0.7)":"rgba(0, 0, 0, "+(1-a.tiles[c][d].lightLevel)+")",this.context.fillRect(c*a.settings.tileSize-Math.round(b.position.x),d*a.settings.tileSize-Math.round(b.position.y),a.settings.tileSize,a.settings.tileSize);this.context.restore()},drawUI:function(){var a=this.game.map,b=this.game.camera,c=document.getElementById("ui");if(null!==this.mousePos){var d=b.position.x%a.settings.tileSize,e=b.position.y%a.settings.tileSize,f=Math.floor((this.mousePos.x+d)/a.settings.tileSize),g=Math.floor((this.mousePos.y+e)/a.settings.tileSize),h=Math.floor((this.mousePos.x+b.position.x)/a.settings.tileSize),i=Math.floor((this.mousePos.y+b.position.y)/a.settings.tileSize),j=new Roguelike.Vector2(h,i);if(a.insideBounds(j)){var k=a.getTileAt(j);if(2===k.type&&k.explored&&(this.context.drawImage(c,0,0,16,16,f*a.settings.tileSize-d,g*a.settings.tileSize-e,a.settings.tileSize,a.settings.tileSize),0!==k.entities.length)){var l=k.entities[k.entities.length-1];if(l.hasComponent("tooltip")){var m=l.getComponent("tooltip"),n=m.fontSize+5;this.context.fillStyle="rgba(0, 0, 0, 0.7)",this.context.fillRect(this.mousePos.x+5,this.mousePos.y+10,m.maxWidth+20,n*(m.title.length+m.type.length+m.description.length)+20);for(var o=0,p=0;p<m.title.length;p++)this.context.font="bold "+m.fontSize+"px "+m.font,this.context.fillStyle="rgba(255, 255, 255, 1)",this.context.fillText(m.title[p],this.mousePos.x+15,this.mousePos.y+15+n+n*o),o++;for(var q=0;q<m.type.length;q++)this.context.font=m.fontSize+"px "+m.font,this.context.fillStyle="rgba(255, 255, 200, 1)",this.context.fillText(m.type[q],this.mousePos.x+15,this.mousePos.y+15+n+n*o),o++;for(var r=0;r<m.description.length;r++)this.context.font=m.fontSize+"px "+m.font,this.context.fillStyle="rgba(180, 180, 180, 1)",this.context.fillText(m.description[r],this.mousePos.x+15,this.mousePos.y+15+n+n*o),o++}}}}},getMousePointer:function(a){var b=this.canvas.getBoundingClientRect();this.mousePos={x:a.clientX-b.left,y:a.clientY-b.top}},clear:function(){this.context.clearRect(0,0,this.game.settings.canvas.width,this.game.settings.canvas.height)}},Roguelike.Systems.Open=function(a){this.game=a},Roguelike.Systems.Open.prototype={handleSingleEntity:function(a){var b=a.getComponent("canOpen"),c=a.getComponent("sprite"),d=a.getComponent("position"),e=a.getComponent("collide"),f=a.getComponent("tooltip");"open"!==b.state&&(b.state="open",c.tile+=1,e.collide=!1,f.type=["Open"],this.game.map.tiles[d.position.x][d.position.y].blockLight=!1)}},Roguelike.Systems.LightMap=function(a){this.game=a,this.mapSize={x:a.map.settings.tilesX,y:a.map.settings.tilesY},this.tiles=[],this.mult=[[1,0,0,-1,-1,0,0,1],[0,1,-1,0,0,-1,1,0],[0,1,1,0,0,-1,-1,0],[1,0,0,1,-1,0,0,-1]]},Roguelike.Systems.LightMap.prototype={update:function(){for(var a=this.game.map.entities.getEntities("lightSource","position"),b=0;b<a.length;b++)this.handleSingleEntity(a[b])},handleSingleEntity:function(a){for(var b=a.getComponent("lightSource"),c=a.getComponent("position"),d=this.clear().concat(this.calculate(b,c.position)),e=0;e<d.length;e++)this.game.map.tiles[d[e].x][d[e].y].lightLevel=d[e].lightLevel,this.game.map.tiles[d[e].x][d[e].y].explored=!0},doesTileBlock:function(a,b){return this.game.map.tiles[a][b].blockLight},calculateOctant:function(a,b,c,d,e,f,g,h,i,j){this.tiles.push({x:a.x,y:a.y,lightLevel:0});var k=0;if(!(d>c))for(var l=e.radius*e.radius,m=b;m<e.radius+1;m++){for(var n=-m-1,o=-m,p=!1;0>=n;){n+=1;var q=a.x+n*f+o*g,r=a.y+n*h+o*i;if(q<this.mapSize.x&&q>=0&&r<this.mapSize.y&&r>=0){var s=(n-.5)/(o+.5),t=(n+.5)/(o-.5);if(t>c)continue;if(d>s)break;if(l>n*n+o*o){var u=new Roguelike.Vector2(q,r),v=a,w=(u.x-v.x)*(u.x-v.x)+(u.y-v.y)*(u.y-v.y);this.tiles.push({x:q,y:r,lightLevel:e.gradient===!1?1:1-w/(e.radius*e.radius)})}if(p){if(this.doesTileBlock(q,r)){k=t;continue}p=!1,c=k}else this.doesTileBlock(q,r)&&m<e.radius&&(p=!0,this.calculateOctant(a,m+1,c,s,e,f,g,h,i,j+1),k=t)}}if(p)break}},clear:function(){for(var a=this.tiles.length;a--;)this.tiles[a].lightLevel=0;var b=this.tiles;return this.tiles=[],b},calculate:function(a,b){for(var c=0;8>c;c++)this.calculateOctant(b,1,1,0,a,this.mult[0][c],this.mult[1][c],this.mult[2][c],this.mult[3][c],0);return this.tiles.push({x:b.x,y:b.y,lightLevel:1}),this.tiles}},Roguelike.Systems.Movement=function(a){this.game=a},Roguelike.Systems.Movement.prototype={handleSingleEntity:function(a,b){var c=a.getComponent("position");if(this.canMove(a,b)){var d=this.game.map.tiles[c.position.x][c.position.y],e=this.game.map.tiles[b.x][b.y];d.removeEntity(a),e.addEntity(a),c.position=b}},canMove:function(a,b){var c=this.game.map.tiles[b.x][b.y];if(2!==c.type)return!1;if(0!==c.entities.length){for(var d=!0,e=0;e<c.entities.length;e++){if(c.entities[e].hasComponent("collide")){var f=c.entities[e].getComponent("collide");f.collide===!0&&(d=!1)}for(var g in c.entities[e].components){if("undefined"==typeof c.entities[e])break;"undefined"!=typeof c.entities[e].components[g].events&&c.entities[e].components[g].events.trigger("bumpInto",a,c.entities[e])}}return d}return!0}},Roguelike.Systems.Combat=function(a){this.game=a},Roguelike.Systems.Combat.prototype={handleSingleEntity:function(a,b){var c=a.getComponent("weapon");if(b.hasComponent("health")){var d=b.getComponent("health");d.takeDamage(c.damage),d.isDead()&&this.removeEntity(b)}},removeEntity:function(a){if(!a.hasComponent("keyboardControl")){this.game.map.entities.removeEntity(a),this.game.scheduler.remove(a);var b=a.getComponent("position"),c=this.game.map.tiles[b.position.x][b.position.y];c.removeEntity(a)}}},Roguelike.Systems.PathFinding=function(a){this.game=a,this.easystar=null,this.initialize()},Roguelike.Systems.PathFinding.prototype={initialize:function(){this.easystar=new EasyStar.js,this.easystar.setGrid(this.game.map.typeList()),this.easystar.disableDiagonals()},handleSingleEntity:function(a,b){this.easystar.setAcceptableTiles(b);var c=a.getComponent("position"),d="attack";switch(d){case"attack":var e=this.game.player,f=e.getComponent("position"),g=this,h=this.game.map.getTileAt(c.position);h.lightLevel>.7&&(this.easystar.findPath(c.position.x,c.position.y,f.position.x,f.position.y,function(b){if(null===b||0===b.length)console.log("no path found");else{var c=new Roguelike.Vector2(b[1].x,b[1].y);g.game.staticSystems.movementSystem.handleSingleEntity(a,c)}}),this.easystar.calculate())}}},Roguelike.moveBehaviours={walkBehaviour:function(){return function(a,b){var c=[2];a.staticSystems.pathfindingSystem.handleSingleEntity(b,c)}},flyBehaviour:function(){return function(a,b){var c=[2];a.staticSystems.pathfindingSystem.handleSingleEntity(b,c)}}},Roguelike.PlayerFactory={newPlayerWarrior:function(a,b,c){var d=new Roguelike.Entity(a,1e3);return d.addComponent(new Roguelike.Components.Health(100)),d.addComponent(new Roguelike.Components.Position(b)),d.addComponent(new Roguelike.Components.Sprite("entities",0,0)),d.addComponent(new Roguelike.Components.KeyboardControl(a,d,c)),d.addComponent(new Roguelike.Components.LightSource(!0,6)),d.addComponent(new Roguelike.Components.Collide(!0)),d.addComponent(new Roguelike.Components.Weapon(7)),d.addComponent(new Roguelike.Components.CanFight(a)),d.addComponent(new Roguelike.Components.Tooltip(a.settings.canvas,"Player","","")),d}},Roguelike.EnemyFactory={newSpider:function(a,b){var c=new Roguelike.Entity(a,2e3);return c.addComponent(new Roguelike.Components.Health(20)),c.addComponent(new Roguelike.Components.Position(b)),c.addComponent(new Roguelike.Components.Sprite("entities",1,2)),c.addComponent(new Roguelike.Components.Collide(!0)),c.addComponent(new Roguelike.Components.Movement(a,c,Roguelike.moveBehaviours.walkBehaviour())),c.addComponent(new Roguelike.Components.Weapon(4)),c.addComponent(new Roguelike.Components.CanFight(a)),c.addComponent(new Roguelike.Components.Tooltip(a.settings.canvas,"Quick Spider","Arachnid Enemy","The quick spider is twice as fast as you and will definitely attack you. It's just programmed to do so.")),c},newSkeleton:function(a,b){var c=new Roguelike.Entity(a,1e3);return c.addComponent(new Roguelike.Components.Health(50)),c.addComponent(new Roguelike.Components.Position(b)),c.addComponent(new Roguelike.Components.Sprite("entities",2,0)),c.addComponent(new Roguelike.Components.Collide(!0)),c.addComponent(new Roguelike.Components.Movement(a,c,Roguelike.moveBehaviours.walkBehaviour())),c.addComponent(new Roguelike.Components.Weapon(10)),c.addComponent(new Roguelike.Components.CanFight(a)),c.addComponent(new Roguelike.Components.Tooltip(a.settings.canvas,"Skeleton","Undead Enemy","The skeleton is a very dangerous but unstable enemy. If you stab just right his bones will collapse.")),c}},Roguelike.PropFactory={newEntrance:function(a,b){var c=new Roguelike.Entity(a);return c.addComponent(new Roguelike.Components.Position(b)),c.addComponent(new Roguelike.Components.Sprite("tileset",3,1)),c},newExit:function(a,b){var c=new Roguelike.Entity(a);return c.addComponent(new Roguelike.Components.Position(b)),c.addComponent(new Roguelike.Components.Sprite("tileset",3,0)),c},newDoor:function(a,b){var c=new Roguelike.Entity(a);return c.addComponent(new Roguelike.Components.Position(b)),c.addComponent(new Roguelike.Components.Sprite("tileset",1,0)),c.addComponent(new Roguelike.Components.CanOpen(a,c)),c.addComponent(new Roguelike.Components.Collide(!0)),c.addComponent(new Roguelike.Components.Tooltip(a.settings.canvas,"Wooden Door","Closed","")),c}},Roguelike.DecorationFactory={newGrass:function(a,b){var c=new Roguelike.Entity(a);return c.addComponent(new Roguelike.Components.Position(b)),c.addComponent(new Roguelike.Components.Sprite("decoration",0,Roguelike.Utils.randomNumber(3,5))),c}},Roguelike.Event=function(){this.events={}},Roguelike.Event.prototype={on:function(a,b,c){this.events.hasOwnProperty(a)||(this.events[a]=[]),this.events[a].push([b,c])},trigger:function(a){var b=Array.prototype.slice.call(arguments,1),c=this.events[a];if(void 0!==c)for(var d=0;d<c.length;d++){var e,f=c[d][0];e=void 0===c[d][1]?this:c[d][1],f.apply(e,b)}}},Roguelike.Key=function(a){this.keyCode=a,this.isDown=!1,this.isUp=!1,this.lastDown=0,this.lastUp=0,this.delay=50,this.onDown=new Roguelike.Event,this.onUp=new Roguelike.Event},Roguelike.Key.prototype={processKeyDown:function(a){this.isDown?a.timeStamp>this.lastDown+this.delay&&(this.onDown.trigger(this.keyCode),this.lastDown=a.timeStamp):(this.isDown=!0,this.isUp=!1,this.lastDown=a.timeStamp,this.onDown.trigger(this.keyCode))},processKeyUp:function(a){this.isDown=!1,this.isUp=!0,this.lastUp=a.timeStamp,this.onUp.trigger(this.keyCode)}},Roguelike.Keyboard=function(){this.keys={},this.initialize()},Roguelike.Keyboard.prototype={initialize:function(){this._onKeyDown=function(a){return this.processKeyDown(a)},this._onKeyUp=function(a){return this.processKeyUp(a)},window.addEventListener("keydown",this._onKeyDown.bind(this),!1),window.addEventListener("keyup",this._onKeyUp.bind(this),!1)},getKey:function(a){return void 0===this.keys[a]&&(this.keys[a]=new Roguelike.Key(a)),this.keys[a]},processKeyDown:function(a){void 0!==this.keys[a.keyCode]&&(a.preventDefault(),this.keys[a.keyCode].processKeyDown(a))},processKeyUp:function(a){void 0!==this.keys[a.keyCode]&&this.keys[a.keyCode].processKeyUp(a)}},Roguelike.Queue=function(){this.time=0,this.events=[],this.eventTimes=[]},Roguelike.Queue.prototype={getTime:function(){return this.time},clear:function(){this.events=[],this.eventTimes=[]},add:function(a,b){for(var c=this.events.length,d=0;d<this.eventTimes.length;d++)if(this.eventTimes[d]>b){c=d;break}this.events.splice(c,0,a),this.eventTimes.splice(c,0,b)},get:function(){if(0===this.events.length)return null;var a=this.eventTimes.splice(0,1)[0];if(a>0){this.time+=a;for(var b=0;b<this.eventTimes.length;b++)this.eventTimes[b]-=a}return this.events.splice(0,1)[0]},remove:function(a){var b=this.events.indexOf(a);return-1===b?!1:(this.events.splice(b,1),this.eventTimes.splice(b,1),!0)}},Roguelike.Scheduler=function(){this.queue=null,this.repeat=[],this.current=null,this.lockCount=0,this.initialize()},Roguelike.Scheduler.prototype={initialize:function(){this.queue=new Roguelike.Queue},getTime:function(){return this.queue.getTime()},add:function(a,b){return this.queue.add(a,1/a.getSpeed()),b&&this.repeat.push(a),this},remove:function(a){var b=this.queue.remove(a),c=this.repeat.indexOf(a);return-1!==c&&this.repeat.splice(c,1),this.current===a&&(this.current=null),b},clear:function(){return this.queue.clear(),this.repeat=[],this.current=null,this},next:function(){return this.current&&-1!==this.repeat.indexOf(this.current)&&this.queue.add(this.current,1/this.current.getSpeed()),this.current=this.queue.get(),this.current},tick:function(){if(this.lockCount>0)return!1;var a=this.next();return null===a?!1:(a.act(),!0)},lock:function(){this.lockCount++},unlock:function(){return 0===this.lockCount?void console.error("You can't unlock an unlocked scheduler!"):void this.lockCount--}},Roguelike.Tile=function(a,b,c,d,e){this.type=a,this.tileRow=d,this.tileNumber=e,this.belongsTo=c||null,this.entities=[],this.blockLight=b,this.lightLevel=0,this.explored=!1},Roguelike.Tile.prototype={addEntity:function(a){this.entities.push(a)},removeEntity:function(a){var b=this.entities.indexOf(a);return-1===b?!1:(this.entities.splice(b,1),!0)}},Roguelike.Map=function(a){this.game=a,this.entities=null,this.settings={},this.rooms=[],this.tiles=[],this.objects=[],this.entrance=null,this.exit=null,this.allRooms=[],this.mediumRooms=[],this.hardRooms=[],this.roomsToExit=[],this.initialize()},Roguelike.Map.prototype={initialize:function(){this.settings={tilesX:60,tilesY:40,tileSize:48,maxRooms:15,minRoomWidth:5,maxRoomWidth:8,minRoomHeight:5,maxRoomHeight:8,roomSpacing:1,maxMainRooms:10,maxMediumRooms:15,maxHardRooms:5};for(var a=0;a<this.settings.tilesX;a++){this.tiles[a]=[];for(var b=0;b<this.settings.tilesY;b++)this.tiles[a][b]=new Roguelike.Tile(0,!0,0,0)}},getTileAt:function(a){var b=this.tiles[a.x][a.y];return b?b:new Roguelike.Tile},insideBounds:function(a){return a.x>0&&a.x<this.settings.tilesX&&a.y>0&&a.y<this.settings.tilesY},typeList:function(){for(var a=[],b=0;b<this.settings.tilesY;b++){a.push([]);for(var c=0;c<this.settings.tilesX;c++)a[b][c]=this.tiles[c][b].type}return a},roomFits:function(a){if(a.x1<1||a.x2>this.settings.tilesX-1||a.y1<1||a.y2>this.settings.tilesY-1)return!1;for(var b=0;b<this.allRooms.length;b++)if(a.x1<=this.allRooms[b].x2&&a.x2>=this.allRooms[b].x1&&a.y1<=this.allRooms[b].y2&&a.y2>=this.allRooms[b].y1)return!1;return!0}},Roguelike.MapFactory=function(a){this.game=a,this.map=a.map,this.possibleDoorLocations=[]},Roguelike.MapFactory.prototype={generateRooms:function(){this.generateFirstRoom(),this.generatePath("path",this.map.roomsToExit,this.map.settings.maxMainRooms),this.generatePath("random",this.map.mediumRooms,this.map.settings.maxMediumRooms),this.generatePath("randomMedium",this.map.hardRooms,this.map.settings.maxHardRooms)},generateFirstRoom:function(){var a=this.newRoom();a.initialize(),this.placeRoom(a),this.map.roomsToExit.push(a)},generatePath:function(a,b,c){for(var d=20,e=0;b.length<c&&!(e>=d);){var f=["left","right","up","down"];switch(a){case"path":var g=this.map.roomsToExit[this.map.roomsToExit.length-1];break;case"random":var h=Roguelike.Utils.randomNumber(0,this.map.allRooms.length-1),g=this.map.allRooms[h];break;case"randomMedium":var h=Roguelike.Utils.randomNumber(0,this.map.mediumRooms.length-1),g=this.map.mediumRooms[h]}for(;;){if(0===f.length){if(e++,e>=d)break;switch(f=["left","right","up","down"],a){case"path":var i=this.map.roomsToExit.splice(this.map.roomsToExit.length-1,1)[0];this.map.mediumRooms.push(i),g=this.map.roomsToExit[this.map.roomsToExit.length-1];break;case"random":h=Roguelike.Utils.randomNumber(0,this.map.allRooms.length-1),g=this.map.allRooms[h];break;case"randomMedium":h=Roguelike.Utils.randomNumber(0,this.map.mediumRooms.length-1),g=this.map.mediumRooms[h]}}for(var j=Roguelike.Utils.randomNumber(0,f.length-1),k=f[j],l=5,m=0,n=this.generateRoomNextTo(g,k);!this.map.roomFits(n);){if(m>=l){f.splice(j,1);break}n=this.generateRoomNextTo(g,k),m++}if(this.map.roomFits(n)){n.initialize(),this.placeRoom(n),b.push(n),g.generateExit(),n.generateExit(),this.generateCorridor(g,n),f=["left","right","up","down"];break}}}},generateRoomNextTo:function(a,b){var c,d,e,f;switch(c=d=e=f=void 0,b){case"up":c=Roguelike.Utils.randomNumber(this.map.settings.minRoomHeight,this.map.settings.maxRoomHeight),e=a.x1+Roguelike.Utils.randomNumber(-2,3),f=a.y1-c-this.map.settings.roomSpacing;break;case"down":e=a.x1+Roguelike.Utils.randomNumber(-2,3),f=a.y2+this.map.settings.roomSpacing;break;case"left":d=Roguelike.Utils.randomNumber(this.map.settings.minRoomWidth,this.map.settings.maxRoomWidth),e=a.x1-d-this.map.settings.roomSpacing,f=a.y1+Roguelike.Utils.randomNumber(-2,3);break;case"right":e=a.x2+this.map.settings.roomSpacing,f=a.y1+Roguelike.Utils.randomNumber(-2,3)}return this.newRoom(d,c,e,f)},newRoom:function(a,b,c,d){var e="undefined"==typeof a?Roguelike.Utils.randomNumber(this.game.map.settings.minRoomWidth,this.game.map.settings.maxRoomWidth):a,f="undefined"==typeof b?Roguelike.Utils.randomNumber(this.game.map.settings.minRoomHeight,this.game.map.settings.maxRoomHeight):b,g="undefined"==typeof c?Roguelike.Utils.randomNumber(1,this.game.map.settings.tilesX-e-1):c,h="undefined"==typeof d?Roguelike.Utils.randomNumber(1,this.game.map.settings.tilesY-f-1):d;return new Roguelike.Room(g,h,e,f)},placeRoom:function(a){this.game.map.allRooms.push(a);for(var b=a.x1;b<a.x2;b++)for(var c=a.x2-b-1,d=a.y1;d<a.y2;d++){var e=a.y2-d-1;2!==this.game.map.tiles[b][d].type&&(this.game.map.tiles[b][d]=a.layout[c][e])}},generateCorridor:function(a,b){var c={x:a.x1+a.exit.x,y:a.y1+a.exit.y},d={x:b.x1+b.exit.x,y:b.y1+b.exit.y};if(d.x!==c.x)if(d.x-c.x>0)for(var e=d.x;e>=c.x;e--)this.generateHorizontalCorridor(e,d.y);else for(var e=d.x;e<=c.x;e++)this.generateHorizontalCorridor(e,d.y);if(d.y!==c.y)if(d.y-c.y>0)for(var e=d.y;e>=c.y;e--)this.generateVerticalCorridor(c.x,e);else for(var e=d.y;e<=c.y;e++)this.generateVerticalCorridor(c.x,e)},generateHorizontalCorridor:function(a,b){var c=this.game.map,d=c.tiles[a][b],e=c.tiles[a][b+1],f=c.tiles[a][b-1];1===d.type&&1===e.type&&1===f.type&&this.possibleDoorLocations.push({x:a,y:b}),this.changeTileToFloor(d),0===e.type&&this.changeTileToWall(e),0===f.type&&this.changeTileToWall(f)},generateVerticalCorridor:function(a,b){var c=this.game.map,d=c.tiles[a][b],e=c.tiles[a+1][b],f=c.tiles[a-1][b];1===d.type&&1===e.type&&1===f.type&&this.possibleDoorLocations.push(new Roguelike.Vector2(a,b)),this.changeTileToFloor(d),0===c.tiles[a+1][b+1].type&&this.changeTileToWall(c.tiles[a+1][b+1]),0===c.tiles[a-1][b-1].type&&this.changeTileToWall(c.tiles[a-1][b-1]),0===c.tiles[a+1][b-1].type&&this.changeTileToWall(c.tiles[a+1][b-1]),0===c.tiles[a-1][b+1].type&&this.changeTileToWall(c.tiles[a-1][b+1])},changeTileToFloor:function(a){a.type=2,a.tileRow=3,a.tileNumber=Roguelike.Utils.randomNumber(2,5),a.blockLight=!1},changeTileToWall:function(a){a.type=1,a.tileRow=0,a.tileNumber=Roguelike.Utils.randomNumber(1,2),a.blockLight=!0}},Roguelike.MapDecorator=function(a){this.game=a},Roguelike.MapDecorator.prototype={decorateMap:function(){this.placeEntrance(),this.placeExit(),this.setTileNumbers(),this.generateDoors(),this.populateDungeon()},setTileNumbers:function(){for(var a=this.game.map,b=0;b<a.settings.tilesX;b++)for(var c=0;c<a.settings.tilesY;c++){if(1===a.tiles[b][c].type){var d=this.game.map.tiles[b-1][c],e=this.game.map.tiles[b+1][c],f=this.game.map.tiles[b][c+1],g=this.game.map.tiles[b][c-1];0===d.type&&2===e.type||0===d.type&&1===e.type&&0===g.type||1===d.type&&1===g.type&&1===f.type||1===d.type&&1===e.type&&0===g.type&&1===f.type?a.tiles[b][c].tileNumber=3:0===e.type&&2===d.type||0===e.type&&1===d.type&&0===g.type||1===e.type&&1===g.type&&1===f.type||1===e.type&&1===d.type&&1===g.type&&0===f.type?a.tiles[b][c].tileNumber=4:1===g.type&&1===d.type&&0===e.type?a.tiles[b][c].tileNumber=6:1===g.type&&1===e.type&&0===d.type?a.tiles[b][c].tileNumber=5:2===g.type&&1===f.type&&2===d.type&&1===e.type?(a.tiles[b][c].tileRow=1,a.tiles[b][c].tileNumber=3):2===g.type&&1===f.type&&1===d.type&&2===e.type?(a.tiles[b][c].tileRow=1,a.tiles[b][c].tileNumber=2):2===g.type&&1===f.type&&2===d.type&&2===e.type?(a.tiles[b][c].tileRow=1,a.tiles[b][c].tileNumber=5):(1===g.type&&1===f.type&&2===d.type&&2===e.type||1===g.type&&1===f.type&&2===d.type&&1===e.type)&&(a.tiles[b][c].tileRow=1,a.tiles[b][c].tileNumber=4)}2===a.tiles[b][c].type&&Roguelike.Utils.randomNumber(0,100)>=80&&(grassEntity=new Roguelike.DecorationFactory.newGrass(this.game,new Roguelike.Vector2(b,c)),a.tiles[b][c].addEntity(grassEntity),a.entities.addEntity(grassEntity))}},placeEntrance:function(){var a=this.game.map.roomsToExit[0].getRandomPosition(),b=Roguelike.PropFactory.newEntrance(this.game,a);
this.game.map.entities.addEntity(b),this.game.map.entrance=a},placeExit:function(){var a=this.game.map.roomsToExit[this.game.map.roomsToExit.length-1].getRandomPosition(),b=Roguelike.PropFactory.newExit(this.game,a);this.game.map.entities.addEntity(b),this.game.map.exit=a},generateDoors:function(){for(var a=0;a<this.game.mapFactory.possibleDoorLocations.length;a++){var b=this.game.mapFactory.possibleDoorLocations[a],c=this.game.map.tiles[b.x-1][b.y],d=this.game.map.tiles[b.x+1][b.y],e=this.game.map.tiles[b.x][b.y-1],f=this.game.map.tiles[b.x][b.y+1],g=Roguelike.Utils.randomNumber(0,100);1===c.type&&1===d.type&&0===e.entities.length&&0===f.entities.length&&2===e.type&&2===f.type&&g>50?this.placeDoor(b,!1):2===c.type&&2===d.type&&0===c.entities.length&&0===d.entities.length&&1===e.type&&1===f.type&&g>50&&this.placeDoor(b,!0)}},placeDoor:function(a,b){var c=this.game.map.tiles[a.x][a.y],d=Roguelike.PropFactory.newDoor(this.game,a);b===!0&&(d.components.sprite.number=0,d.components.sprite.row=2),this.game.map.entities.addEntity(d),c.addEntity(d),c.blockLight=!0},populateDungeon:function(){for(var a=0;a<this.game.map.mediumRooms.length;a++)for(var b=this.game.map.mediumRooms[a],c=b.x1;c<b.x2;c++)for(var d=b.y1;d<b.y2;d++)2===this.game.map.tiles[c][d].type&&Roguelike.Utils.randomNumber(0,100)>=90&&(enemyEntity=new Roguelike.EnemyFactory.newSpider(this.game,new Roguelike.Vector2(c,d)),this.game.map.tiles[c][d].addEntity(enemyEntity),this.game.map.entities.addEntity(enemyEntity),this.game.scheduler.add(enemyEntity,!0));for(var a=0;a<this.game.map.hardRooms.length;a++)for(var b=this.game.map.hardRooms[a],c=b.x1;c<b.x2;c++)for(var d=b.y1;d<b.y2;d++)2===this.game.map.tiles[c][d].type&&Roguelike.Utils.randomNumber(0,100)>=90&&(enemyEntity=new Roguelike.EnemyFactory.newSkeleton(this.game,new Roguelike.Vector2(c,d)),this.game.map.tiles[c][d].addEntity(enemyEntity),this.game.map.entities.addEntity(enemyEntity),this.game.scheduler.add(enemyEntity,!0))}},Roguelike.Room=function(a,b,c,d){this.x1=a,this.x2=c+a,this.y1=b,this.y2=b+d,this.w=c,this.h=d,this.layout=[],this.exit=null},Roguelike.Room.prototype={initialize:function(){for(var a=0;a<this.w;a++){this.layout[a]=[];for(var b=0;b<this.h;b++)this.layout[a][b]=0===b||b===this.h-1||0===a||a===this.w-1?new Roguelike.Tile(1,!0,this,0,Roguelike.Utils.randomNumber(1,2)):new Roguelike.Tile(2,!1,this,3,2)}},generateExit:function(){switch(Roguelike.Utils.randomNumber(1,4)){case 1:this.exit={x:Roguelike.Utils.randomNumber(1,this.w-2),y:this.h-2};break;case 2:this.exit={x:Roguelike.Utils.randomNumber(1,this.w-2),y:1};break;case 3:this.exit={x:this.w-2,y:Roguelike.Utils.randomNumber(1,this.h-2)};break;case 4:this.exit={x:1,y:Roguelike.Utils.randomNumber(1,this.h-2)}}},getRandomPosition:function(){var a=Roguelike.Utils.randomNumber(2,this.w-3),b=Roguelike.Utils.randomNumber(2,this.h-3);return a+=this.x1,b+=this.y1,new Roguelike.Vector2(a,b)}};var EasyStar=EasyStar||{};EasyStar.Node=function(a,b,c,d,e){this.parent=a,this.x=b,this.y=c,this.costSoFar=d,this.simpleDistanceToTarget=e,this.bestGuessDistance=function(){return this.costSoFar+this.simpleDistanceToTarget}},EasyStar.Node.OPEN_LIST=0,EasyStar.Node.CLOSED_LIST=1,EasyStar.PriorityQueue=function(a,b){this.length=0;var c=[],d=!1;if(b==EasyStar.PriorityQueue.MAX_HEAP)d=!0;else{if(b!=EasyStar.PriorityQueue.MIN_HEAP)throw b+" not supported.";d=!1}this.insert=function(b){if(!b.hasOwnProperty(a))throw"Cannot insert "+b+" because it does not have a property by the name of "+a+".";c.push(b),this.length++,e(this.length-1)},this.getHighestPriorityElement=function(){return c[0]},this.shiftHighestPriorityElement=function(){if(0===this.length)throw"There are no more elements in your priority queue.";if(1===this.length){var a=c[0];return c=[],this.length=0,a}var b=c[0],d=c.pop();return this.length--,c[0]=d,f(0),b};var e=function(a){if(0!==a){var b=i(a);h(a,b)&&(g(a,b),e(b))}},f=function(a){if(left=j(a),right=k(a),h(left,a))g(a,left),f(left);else if(h(right,a))g(a,right),f(right);else{if(0==a)return;f(0)}},g=function(a,b){var d=c[a];c[a]=c[b],c[b]=d},h=function(b,e){return void 0===c[e]||void 0===c[b]?!1:("function"==typeof c[b][a]?(selfValue=c[b][a](),targetValue=c[e][a]()):(selfValue=c[b][a],targetValue=c[e][a]),d?selfValue>targetValue?!0:!1:targetValue>selfValue?!0:!1)},i=function(a){return Math.floor(a/2)-1},j=function(a){return 2*a+1},k=function(a){return 2*a+2}},EasyStar.PriorityQueue.MAX_HEAP=0,EasyStar.PriorityQueue.MIN_HEAP=1,EasyStar.instance=function(){this.isDoneCalculating=!0,this.pointsToAvoid={},this.startX,this.callback,this.startY,this.endX,this.endY,this.nodeHash={},this.openList},EasyStar.js=function(){var a,b,c,d=10,e=14,f={},g={},h=[],i=Number.MAX_VALUE,j=!1;this.setAcceptableTiles=function(a){a instanceof Array?c=a:!isNaN(parseFloat(a))&&isFinite(a)&&(c=[a])},this.enableDiagonals=function(){j=!0},this.disableDiagonals=function(){j=!1},this.setGrid=function(b){a=b;for(var c=0;c<a.length;c++)for(var d=0;d<a[0].length;d++)g[a[c][d]]||(g[a[c][d]]=1)},this.setTileCost=function(a,b){g[a]=b},this.setIterationsPerCalculation=function(a){i=a},this.avoidAdditionalPoint=function(a,b){f[a+"_"+b]=1},this.stopAvoidingAdditionalPoint=function(a,b){delete f[a+"_"+b]},this.stopAvoidingAllAdditionalPoints=function(){f={}},this.findPath=function(b,e,f,g,i){if(void 0===c)throw"You can't set a path without first calling setAcceptableTiles() on EasyStar.";if(void 0===a)throw"You can't set a path without first calling setGrid() on EasyStar.";if(0>b||0>e||0>f||0>f||b>a[0].length-1||e>a.length-1||f>a[0].length-1||g>a.length-1)throw"Your start or end point is outside the scope of your grid.";b===f&&e===g&&i([]);for(var j=a[g][f],k=!1,m=0;m<c.length;m++)if(j===c[m]){k=!0;break}if(k===!1)return void i(null);var n=new EasyStar.instance;n.openList=new EasyStar.PriorityQueue("bestGuessDistance",EasyStar.PriorityQueue.MIN_HEAP),n.isDoneCalculating=!1,n.nodeHash={},n.startX=b,n.startY=e,n.endX=f,n.endY=g,n.callback=i,n.openList.insert(l(n,n.startX,n.startY,null,d)),h.push(n)},this.calculate=function(){if(0!==h.length&&void 0!==a&&void 0!==c)for(b=0;i>b;b++){if(0===h.length)return;if(0!==h[0].openList.length){var f=h[0].openList.shiftHighestPriorityElement();if(f.list=EasyStar.Node.CLOSED_LIST,f.y>0&&(k(h[0],f,0,-1,d*g[a[f.y-1][f.x]]),h[0].isDoneCalculating===!0))h.shift();else if(f.x<a[0].length-1&&(k(h[0],f,1,0,d*g[a[f.y][f.x+1]]),h[0].isDoneCalculating===!0))h.shift();else if(f.y<a.length-1&&(k(h[0],f,0,1,d*g[a[f.y+1][f.x]]),h[0].isDoneCalculating===!0))h.shift();else if(f.x>0&&(k(h[0],f,-1,0,d*g[a[f.y][f.x-1]]),h[0].isDoneCalculating===!0))h.shift();else if(j){if(f.x>0&&f.y>0&&(k(h[0],f,-1,-1,e*g[a[f.y-1][f.x-1]]),h[0].isDoneCalculating===!0)){h.shift();continue}if(f.x<a[0].length-1&&f.y<a.length-1&&(k(h[0],f,1,1,e*g[a[f.y+1][f.x+1]]),h[0].isDoneCalculating===!0)){h.shift();continue}if(f.x<a[0].length-1&&f.y>0&&(k(h[0],f,1,-1,e*g[a[f.y-1][f.x+1]]),h[0].isDoneCalculating===!0)){h.shift();continue}if(f.x>0&&f.y<a.length-1&&(k(h[0],f,-1,1,e*g[a[f.y+1][f.x-1]]),h[0].isDoneCalculating===!0)){h.shift();continue}}}else h[0].callback(null),h.shift()}};var k=function(b,d,e,g,h){var i=d.x+e,j=d.y+g;if(b.endX===i&&b.endY===j){b.isDoneCalculating=!0;var k=[],m=0;k[m]={x:i,y:j},m++,k[m]={x:d.x,y:d.y},m++;for(var n=d.parent;null!=n;)k[m]={x:n.x,y:n.y},m++,n=n.parent;k.reverse(),b.callback(k)}if(void 0===f[i+"_"+j])for(var o=0;o<c.length;o++)if(a[j][i]===c[o]){var p=l(b,i,j,d,h);void 0===p.list?(p.list=EasyStar.Node.OPEN_LIST,b.openList.insert(p)):p.list===EasyStar.Node.OPEN_LIST&&d.costSoFar+h<p.costSoFar&&(p.costSoFar=d.costSoFar+h,p.parent=d);break}},l=function(a,b,c,d,e){if(void 0!==a.nodeHash[b+"_"+c])return a.nodeHash[b+"_"+c];var f=m(b,c,a.endX,a.endY);if(null!==d)var g=d.costSoFar+e;else g=f;var h=new EasyStar.Node(d,b,c,g,f);return a.nodeHash[b+"_"+c]=h,h},m=function(a,b,c,d){return Math.floor(Math.abs(b-a)+Math.abs(d-c))}},"function"==typeof define&&define.amd&&define("easystar",[],function(){return EasyStar});var MersenneTwister=function(a){void 0==a&&(a=(new Date).getTime()),this.N=624,this.M=397,this.MATRIX_A=2567483615,this.UPPER_MASK=2147483648,this.LOWER_MASK=2147483647,this.mt=new Array(this.N),this.mti=this.N+1,this.init_genrand(a)};MersenneTwister.prototype.init_genrand=function(a){for(this.mt[0]=a>>>0,this.mti=1;this.mti<this.N;this.mti++){var a=this.mt[this.mti-1]^this.mt[this.mti-1]>>>30;this.mt[this.mti]=(1812433253*((4294901760&a)>>>16)<<16)+1812433253*(65535&a)+this.mti,this.mt[this.mti]>>>=0}},MersenneTwister.prototype.init_by_array=function(a,b){var c,d,e;for(this.init_genrand(19650218),c=1,d=0,e=this.N>b?this.N:b;e;e--){var f=this.mt[c-1]^this.mt[c-1]>>>30;this.mt[c]=(this.mt[c]^(1664525*((4294901760&f)>>>16)<<16)+1664525*(65535&f))+a[d]+d,this.mt[c]>>>=0,c++,d++,c>=this.N&&(this.mt[0]=this.mt[this.N-1],c=1),d>=b&&(d=0)}for(e=this.N-1;e;e--){var f=this.mt[c-1]^this.mt[c-1]>>>30;this.mt[c]=(this.mt[c]^(1566083941*((4294901760&f)>>>16)<<16)+1566083941*(65535&f))-c,this.mt[c]>>>=0,c++,c>=this.N&&(this.mt[0]=this.mt[this.N-1],c=1)}this.mt[0]=2147483648},MersenneTwister.prototype.genrand_int32=function(){var a,b=new Array(0,this.MATRIX_A);if(this.mti>=this.N){var c;for(this.mti==this.N+1&&this.init_genrand(5489),c=0;c<this.N-this.M;c++)a=this.mt[c]&this.UPPER_MASK|this.mt[c+1]&this.LOWER_MASK,this.mt[c]=this.mt[c+this.M]^a>>>1^b[1&a];for(;c<this.N-1;c++)a=this.mt[c]&this.UPPER_MASK|this.mt[c+1]&this.LOWER_MASK,this.mt[c]=this.mt[c+(this.M-this.N)]^a>>>1^b[1&a];a=this.mt[this.N-1]&this.UPPER_MASK|this.mt[0]&this.LOWER_MASK,this.mt[this.N-1]=this.mt[this.M-1]^a>>>1^b[1&a],this.mti=0}return a=this.mt[this.mti++],a^=a>>>11,a^=a<<7&2636928640,a^=a<<15&4022730752,a^=a>>>18,a>>>0},MersenneTwister.prototype.genrand_int31=function(){return this.genrand_int32()>>>1},MersenneTwister.prototype.genrand_real1=function(){return this.genrand_int32()*(1/4294967295)},MersenneTwister.prototype.random=function(){return this.genrand_int32()*(1/4294967296)},MersenneTwister.prototype.genrand_real3=function(){return(this.genrand_int32()+.5)*(1/4294967296)},MersenneTwister.prototype.genrand_res53=function(){var a=this.genrand_int32()>>>5,b=this.genrand_int32()>>>6;return(67108864*a+b)*(1/9007199254740992)};var seed=Math.floor(401*Math.random()+100);console.log(seed),Roguelike.Utils={mersenneTwister:new MersenneTwister(seed),randomNumber:function(a,b){return Math.floor(this.mersenneTwister.random()*(b-a+1)+a)},extend:function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a},contains:function(a,b){for(var c=0;c<b.length;c++)if(b[c]===a)return c;return-1}},window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(a){window.setTimeout(a,1e3/60)}}(),window.addEventListener("load",initializeCanvas);