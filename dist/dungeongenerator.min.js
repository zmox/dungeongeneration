/*! Dungeon Generator - v1.8.0 - 2014-04-22
* https://github.com/stefanweck/dungeongeneration
* Copyright (c) 2014 Stefan Weck */
function initializeCanvas(){var a=document.getElementById("canvas");a.width=900,a.height=600;{var b={canvas:a,tilesX:60,tilesY:40,tileSize:48,maxRooms:15,minRoomWidth:6,maxRoomWidth:10,minRoomHeight:6,maxRoomHeight:10,debug:!1};new Roguelike.Game(b)}}var Roguelike=Roguelike||{VERSION:"1.8.0",Components:{},Systems:{}};Roguelike.Game=function(a){this.isInitialized=!1,this.map=null,this.systems=[],this.camera=null,this.player=null,this.settings={canvas:null,tilesX:60,tilesY:40,tileSize:20,maxRooms:10,minRoomWidth:6,maxRoomWidth:12,minRoomHeight:6,maxRoomHeight:12,debug:!1},this.settings=Roguelike.Utils.extend(this.settings,a),this.initialize()},Roguelike.Game.prototype={initialize:function(){if(!this.isInitialized){this.map=new Roguelike.Map(this),this.map.initialize(),this.map.entities=new Roguelike.Group(this),this.map.mapFactory.generateRooms(),this.map.addRooms(),this.map.mapFactory.generateCorridors(),this.map.mapFactory.generateDoors(),this.map.mapFactory.placeEntranceExitObjects(),this.map.mapFactory.decorateDungeon(),this.camera=new Roguelike.Camera(this,{x:0,y:0});var a=new Roguelike.Vector2(this.map.entrance.x,this.map.entrance.y);this.player=Roguelike.PlayerFactory.newPlayerWarrior(a),this.map.entities.addEntity(this.player),this.camera.follow(this.player,this.settings.canvas.width/2,this.settings.canvas.height/2),this.systems.push(new Roguelike.Systems.PathFinding(this)),this.systems.push(new Roguelike.Systems.Control(this)),this.systems.push(new Roguelike.Systems.Movement(this)),this.systems.push(new Roguelike.Systems.Open(this)),this.systems.push(new Roguelike.Systems.Combat(this)),this.systems.push(new Roguelike.Systems.LightMap(this)),this.systems.push(new Roguelike.Systems.Render(this)),this.update(),this.isInitialized=!0}},update:function(){for(var a=0;a<this.systems.length;a++)this.systems[a].update()}},Roguelike.Utils={randomNumber:function(a,b){return Math.floor(Math.random()*(b-a+1)+a)},extend:function(a,b){for(var c in b)b.hasOwnProperty(c)&&(a[c]=b[c]);return a},contains:function(a,b){for(var c=0;c<b.length;c++)if(b[c]===a)return c;return!1}},Roguelike.Camera=function(a,b){this.game=a,this.position=b,this.viewportWidth=a.settings.canvas.width,this.viewportHeight=a.settings.canvas.height,this.minimumDistanceX=0,this.minimumDistanceY=0,this.followObject=null,this.viewportBoundary=new Roguelike.Boundary(this.position.x*a.settings.tileSize,this.position.y*a.settings.tileSize,this.viewportWidth,this.viewportHeight),this.mapBoundary=new Roguelike.Boundary(0,0,a.settings.tilesX*a.settings.tileSize,a.settings.tilesY*a.settings.tileSize)},Roguelike.Camera.prototype={follow:function(a,b,c){this.followObject=a.components.position,this.minimumDistanceX=b,this.minimumDistanceY=c},update:function(){if(null!==this.followObject){var a=this.game.settings.tileSize;this.followObject.position.x*a-this.position.x+this.minimumDistanceX>this.viewportWidth?this.position.x=this.followObject.position.x*a-(this.viewportWidth-this.minimumDistanceX):this.followObject.position.x*a-this.minimumDistanceX<this.position.x&&(this.position.x=this.followObject.position.x*a-this.minimumDistanceX),this.followObject.position.y*a-this.position.y+this.minimumDistanceY>this.viewportHeight?this.position.y=this.followObject.position.y*a-(this.viewportHeight-this.minimumDistanceY):this.followObject.position.y*a-this.minimumDistanceY<this.position.y&&(this.position.y=this.followObject.position.y*a-this.minimumDistanceY)}this.viewportBoundary.set(this.position.x,this.position.y),this.viewportBoundary.isWithin(this.mapBoundary)||(this.viewportBoundary.left<this.mapBoundary.left&&(this.position.x=this.mapBoundary.left),this.viewportBoundary.top<this.mapBoundary.top&&(this.position.y=this.mapBoundary.top),this.viewportBoundary.right>this.mapBoundary.right&&(this.position.x=this.mapBoundary.right-this.viewportWidth),this.viewportBoundary.bottom>this.mapBoundary.bottom&&(this.position.y=this.mapBoundary.bottom-this.viewportHeight))}},Roguelike.Vector2=function(a,b){this.x=a,this.y=b},Roguelike.Vector2.prototype={add:function(){var a=pos.x-this.x,b=pos.y-this.y;return Math.abs(Math.sqrt(a*a+b*b))},distance:function(a){var b=a.x-this.x,c=a.y-this.y;return Math.abs(Math.sqrt(b*b+c*c))},manhattan:function(a){return Math.abs(this.x-a.x)+Math.abs(this.y-a.y)},clone:function(){return new Vector2(this.x,this.y)},toString:function(){return"("+this.x+", "+this.y+")"}},Roguelike.Boundary=function(a,b,c,d){this.left=a||0,this.top=b||0,this.width=c||0,this.height=d||0,this.right=this.left+this.width,this.bottom=this.top+this.height},Roguelike.Boundary.prototype={set:function(a,b,c,d){this.left=a,this.top=b,this.width=c||this.width,this.height=d||this.height,this.right=this.left+this.width,this.bottom=this.top+this.height},isWithin:function(a){return a.left<=this.left&&a.right>=this.right&&a.top<=this.top&&a.bottom>=this.bottom},isOverlapping:function(a){return this.left<a.right&&a.left<this.right&&this.top<a.bottom&&a.top<this.bottom}},Roguelike.Entity=function(){this.components={},this.onAddComponent=new Roguelike.Event,this.onRemoveComponent=new Roguelike.Event},Roguelike.Entity.prototype={hasComponent:function(a){return void 0!==this.components[a]},getComponent:function(a){return this.components[a]},addComponent:function(a){this.components[a.name]=a,this.onAddComponent.trigger(a)},removeComponent:function(a){this.components[a.name]=void 0,this.onRemoveComponent.trigger(a)}},Roguelike.Group=function(a){this.game=a,this.entities=[]},Roguelike.Group.prototype={addEntity:function(a){!a instanceof Roguelike.Entity||this.entities.push(a)},removeEntity:function(a){var b=Roguelike.Utils.contains(a,this.entities);b!==!1&&this.entities.splice(b,1)},getEntities:function(){for(var a=[],b=0;b<this.entities.length;b++){for(var c=[],d=0;d<arguments.length;d++)this.entities[b].components[arguments[d]]&&c.push(1);c.length===arguments.length&&a.push(this.entities[b])}return a}},Roguelike.Components.Sprite=function(a,b,c){this.name="sprite",this.sprite=a,this.row=b,this.tile=c},Roguelike.Components.Health=function(a){this.name="health",this.health=this.maxHealth=a},Roguelike.Components.Health.prototype={isDead:function(){return this.health<=0},takeDamage:function(a){this.health-=a}},Roguelike.Components.CanOpen=function(){this.name="canOpen",this.events=new Roguelike.Event,this.state="closed",this.actions=[],this.initialize()},Roguelike.Components.CanOpen.prototype={initialize:function(){this.events.on("bumpInto",this.bumpInto,this)},bumpInto:function(){"closed"===this.state&&this.actions.push("open")}},Roguelike.Components.LightSource=function(a,b){this.name="lightSource",this.gradient=a,this.radius=b},Roguelike.Components.Collide=function(a){this.name="collide",this.collide=a},Roguelike.Components.KeyboardControl=function(){this.name="keyboardControl"},Roguelike.Components.Position=function(a){this.name="position",this.position=a,this.actions=[]},Roguelike.Components.Weapon=function(a){this.name="weapon",this.damage=a},Roguelike.Components.CanFight=function(){this.name="canFight",this.events=new Roguelike.Event,this.actions=[],this.initialize()},Roguelike.Components.CanFight.prototype={initialize:function(){this.events.on("bumpInto",this.bumpInto,this)},bumpInto:function(a,b){this.actions.push(b)}},Roguelike.Components.Behaviour=function(a){this.name="behaviour",this.behaviour=a},Roguelike.Systems.Render=function(a){this.game=a,this.canvas=null,this.context=null,this.tileColors=["#302222","#443939","#6B5B45"],this.initialize()},Roguelike.Systems.Render.prototype={initialize:function(){this.canvas=this.game.settings.canvas,this.context=this.game.settings.canvas.getContext("2d"),this.context.mozImageSmoothingEnabled=!1,this.context.webkitImageSmoothingEnabled=!1,this.context.msImageSmoothingEnabled=!1,this.context.imageSmoothingEnabled=!1},drawMap:function(){var a=this.game.map,b=this.game.camera,c=document.getElementById("tileset");this.context.save();for(var d=0;d<a.tilesX;d++)for(var e=0;e<a.tilesY;e++){var f=a.tiles[d][e].tileRow,g=a.tiles[d][e].tileNumber;this.context.drawImage(c,16*g,16*f,16,16,d*a.tileSize-b.position.x,e*a.tileSize-b.position.y,this.game.map.tileSize,this.game.map.tileSize)}this.context.restore()},update:function(){this.game.camera.update(),this.clear(),this.drawMap();var a=this.game.map.entities.getEntities("position","sprite");this.context.save();for(var b=0;b<a.length;b++){var c=a[b].getComponent("sprite"),d=a[b].getComponent("position"),e=document.getElementById(c.sprite);if(this.context.drawImage(e,16*c.tile,16*c.row,16,16,d.position.x*this.game.map.tileSize-this.game.camera.position.x,d.position.y*this.game.map.tileSize-this.game.camera.position.y,this.game.map.tileSize,this.game.map.tileSize),a[b].hasComponent("health")){var f=a[b].getComponent("health");this.context.font="bold 12pt arial",this.context.fillStyle="white",this.context.fillText(f.health,d.position.x*this.game.map.tileSize-this.game.camera.position.x,d.position.y*this.game.map.tileSize-this.game.camera.position.y)}}this.context.restore(),this.drawLightMap()},drawLightMap:function(){var a=this.game.map,b=this.game.camera;this.context.save();for(var c=0;c<a.tilesX;c++)for(var d=0;d<a.tilesY;d++)this.context.fillStyle=a.tiles[c][d].explored===!0&&1-a.tiles[c][d].lightLevel>.7?"rgba(0, 0, 0, 0.7)":"rgba(0, 0, 0, "+(1-a.tiles[c][d].lightLevel)+")",this.context.fillRect(c*a.tileSize-b.position.x,d*a.tileSize-b.position.y,a.tileSize,a.tileSize);this.context.restore()},clear:function(){this.context.clearRect(0,0,this.game.settings.canvas.width,this.game.settings.canvas.height)}},Roguelike.Systems.Open=function(a){this.game=a},Roguelike.Systems.Open.prototype={update:function(){for(var a=this.game.map.entities.getEntities("canOpen","sprite","position","collide"),b=0;b<a.length;b++){var c=a[b].getComponent("canOpen"),d=a[b].getComponent("sprite"),e=a[b].getComponent("position"),f=a[b].getComponent("collide");if(0!==c.actions.length)for(var g=c.actions.length;g>0;g--){var h=c.actions.pop();"open"===h&&(c.state="open",d.tile+=1,f.collide=!1,this.game.map.tiles[e.position.x][e.position.y].blockLight=!1)}}}},Roguelike.Systems.LightMap=function(a){this.game=a,this.mapSize={x:a.map.tilesX,y:a.map.tilesY},this.tiles=[],this.mult=[[1,0,0,-1,-1,0,0,1],[0,1,-1,0,0,-1,1,0],[0,1,1,0,0,-1,-1,0],[1,0,0,1,-1,0,0,-1]]},Roguelike.Systems.LightMap.prototype={doesTileBlock:function(a,b){return this.game.map.tiles[a][b].blockLight},calculateOctant:function(a,b,c,d,e,f,g,h,i,j){this.tiles.push({x:a.x,y:a.y,lightLevel:0});var k=0;if(!(d>c))for(var l=e.radius*e.radius,m=b;m<e.radius+1;m++){for(var n=-m-1,o=-m,p=!1;0>=n;){n+=1;var q=a.x+n*f+o*g,r=a.y+n*h+o*i;if(q<this.mapSize.x&&q>=0&&r<this.mapSize.y&&r>=0){var s=(n-.5)/(o+.5),t=(n+.5)/(o-.5);if(t>c)continue;if(d>s)break;if(l>n*n+o*o){var u=new Roguelike.Vector2(q,r),v=a,w=(u.x-v.x)*(u.x-v.x)+(u.y-v.y)*(u.y-v.y);this.tiles.push({x:q,y:r,lightLevel:e.gradient===!1?1:1-w/(e.radius*e.radius)})}if(p){if(this.doesTileBlock(q,r)){k=t;continue}p=!1,c=k}else this.doesTileBlock(q,r)&&m<e.radius&&(p=!0,this.calculateOctant(a,m+1,c,s,e,f,g,h,i,j+1),k=t)}}if(p)break}},clear:function(){for(var a=this.tiles.length;a--;)this.tiles[a].lightLevel=0;var b=this.tiles;return this.tiles=[],b},calculate:function(a,b){for(var c=0;8>c;c++)this.calculateOctant(b,1,1,0,a,this.mult[0][c],this.mult[1][c],this.mult[2][c],this.mult[3][c],0);return this.tiles.push({x:b.x,y:b.y,lightLevel:1}),this.tiles},update:function(){for(var a=this.game.map.entities.getEntities("lightSource","position"),b=0;b<a.length;b++)for(var c=a[b].getComponent("lightSource"),d=a[b].getComponent("position"),e=this.clear().concat(this.calculate(c,d.position)),f=0;f<e.length;f++)this.game.map.tiles[e[f].x][e[f].y].lightLevel=e[f].lightLevel,this.game.map.tiles[e[f].x][e[f].y].explored=!0}},Roguelike.Systems.Control=function(a){this.game=a,this.keyboard=null,this.upKey=null,this.downKey=null,this.leftKey=null,this.rightKey=null,this.initialize()},Roguelike.Systems.Control.prototype={initialize:function(){this.keyboard=new Roguelike.Keyboard(this),this.keyboard.initialize();var a=this;this.upKey=this.keyboard.getKey(38);var b=function(){a.keyHandler(38)};this.upKey.onDown.on(38,b,a),this.downKey=this.keyboard.getKey(40);var c=function(){a.keyHandler(40)};this.downKey.onDown.on(40,c,a),this.leftKey=this.keyboard.getKey(37);var d=function(){a.keyHandler(37)};this.leftKey.onDown.on(37,d,a),this.rightKey=this.keyboard.getKey(39);var e=function(){a.keyHandler(39)};this.rightKey.onDown.on(39,e,a)},keyHandler:function(a){for(var b=this.game.map.entities.getEntities("keyboardControl","position"),c=0;c<b.length;c++)this.queueMovement(a,b[c]);this.game.update()},update:function(){},queueMovement:function(a,b){var c,d=b.getComponent("position");switch(a){case 37:c=new Roguelike.Vector2(d.position.x-1,d.position.y);break;case 38:c=new Roguelike.Vector2(d.position.x,d.position.y-1);break;case 39:c=new Roguelike.Vector2(d.position.x+1,d.position.y);break;case 40:c=new Roguelike.Vector2(d.position.x,d.position.y+1)}d.actions.push(c)}},Roguelike.Systems.Movement=function(a){this.game=a},Roguelike.Systems.Movement.prototype={update:function(){for(var a=this.game.map.entities.getEntities("position"),b=0;b<a.length;b++)for(var c=a[b].getComponent("position"),d=c.actions.length-1;d>=0;d--){var e=c.actions[d];if(this.canMove(a[b],e)){var f=this.game.map.tiles[c.position.x][c.position.y],g=this.game.map.tiles[e.x][e.y],h=f.entities.indexOf(a[b]);f.entities.splice(h,1),g.entities.push(a[b]),c.position=e}c.actions.splice(d,1)}},canMove:function(a,b){var c=this.game.map.tiles[b.x][b.y];if(2!==c.type)return!1;if(0!==c.entities.length)for(var d=0;d<c.entities.length;d++){for(var e in c.entities[d].components)"undefined"!=typeof c.entities[d].components[e].events&&c.entities[d].components[e].events.trigger("bumpInto",a,c.entities[d]);if(c.entities[d].hasComponent("collide")){var f=c.entities[d].getComponent("collide");if(f.collide===!0)return!1}}return!0}},Roguelike.Systems.Combat=function(a){this.game=a,this.toRemove=[]},Roguelike.Systems.Combat.prototype={update:function(){for(var a=this.game.map.entities.getEntities("weapon","canFight"),b=0;b<a.length;b++){var c=a[b].getComponent("canFight"),d=a[b].getComponent("weapon");if(0!==c.actions.length)for(var e=c.actions.length;e>0;e--){var f=c.actions.pop();if(f.hasComponent("health")){var g=f.getComponent("health");g.takeDamage(d.damage),g.isDead()&&this.toRemove.push(f)}}}for(var h;h=this.toRemove.pop();){this.game.map.entities.removeEntity(h);var i=h.getComponent("position"),j=this.game.map.tiles[i.position.x][i.position.y],k=j.entities.indexOf(h);j.entities.splice(k,1)}}},Roguelike.Systems.PathFinding=function(a){this.game=a,this.easystar=null,this.initialize()},Roguelike.Systems.PathFinding.prototype={initialize:function(){this.easystar=new EasyStar.js,this.easystar.setGrid(this.game.map.typeList()),this.easystar.disableDiagonals(),this.easystar.setAcceptableTiles([2])},update:function(){for(var a=this.game.map.entities.getEntities("behaviour","position"),b=0;b<a.length;b++){var c=a[b].getComponent("behaviour"),d=a[b].getComponent("position");switch(c.behaviour){case"attack":var e,f=this.game.player,g=f.getComponent("position");d.position.manhattan(g.position)<10&&(this.easystar.findPath(d.position.x,d.position.y,g.position.x,g.position.y,function(a){null===a||0===a.length?console.log("no path found"):(e=new Roguelike.Vector2(a[1].x,a[1].y),d.actions.push(e))}),this.easystar.calculate())}}}},Roguelike.PlayerFactory={newPlayerWarrior:function(a){var b=new Roguelike.Entity;return b.addComponent(new Roguelike.Components.Health(100)),b.addComponent(new Roguelike.Components.Position(a)),b.addComponent(new Roguelike.Components.Sprite("entities",0,0)),b.addComponent(new Roguelike.Components.KeyboardControl),b.addComponent(new Roguelike.Components.LightSource(!0,6)),b.addComponent(new Roguelike.Components.Collide(!0)),b.addComponent(new Roguelike.Components.Weapon(5)),b.addComponent(new Roguelike.Components.CanFight),b}},Roguelike.EnemyFactory={newSkeleton:function(a){var b=new Roguelike.Entity;return b.addComponent(new Roguelike.Components.Health(20)),b.addComponent(new Roguelike.Components.Position(a)),b.addComponent(new Roguelike.Components.Sprite("entities",0,2)),b.addComponent(new Roguelike.Components.Collide(!0)),b.addComponent(new Roguelike.Components.Weapon(10)),b.addComponent(new Roguelike.Components.CanFight),b.addComponent(new Roguelike.Components.Behaviour("attack")),b}},Roguelike.PropFactory={newDoor:function(a){var b=new Roguelike.Entity;return b.addComponent(new Roguelike.Components.Position(a)),b.addComponent(new Roguelike.Components.Sprite("tileset",1,0)),b.addComponent(new Roguelike.Components.CanOpen),b.addComponent(new Roguelike.Components.Collide(!0)),b}},Roguelike.DecorationFactory={newGrass:function(a){var b=new Roguelike.Entity;return b.addComponent(new Roguelike.Components.Position(a)),b.addComponent(new Roguelike.Components.Sprite("decoration",0,Roguelike.Utils.randomNumber(3,5))),b}},Roguelike.Event=function(){this.events={}},Roguelike.Event.prototype={on:function(a,b,c){this.events.hasOwnProperty(a)||(this.events[a]=[]),this.events[a].push([b,c])},trigger:function(a){var b=Array.prototype.slice.call(arguments,1),c=this.events[a];if(void 0!==c)for(var d=0;d<c.length;d++){var e,f=c[d][0];e=void 0===c[d][1]?this:c[d][1],f.apply(e,b)}}},Roguelike.Key=function(a){this.keyCode=a,this.isDown=!1,this.isUp=!1,this.lastDown=0,this.lastUp=0,this.delay=50,this.onDown=new Roguelike.Event,this.onUp=new Roguelike.Event},Roguelike.Key.prototype={processKeyDown:function(a){this.isDown?a.timeStamp>this.lastDown+this.delay&&(this.onDown.trigger(this.keyCode),this.lastDown=a.timeStamp):(this.isDown=!0,this.isUp=!1,this.lastDown=a.timeStamp,this.onDown.trigger(this.keyCode))},processKeyUp:function(a){this.isDown=!1,this.isUp=!0,this.lastUp=a.timeStamp,this.onUp.trigger(this.keyCode)}},Roguelike.Keyboard=function(a){this.game=a,this.keys={}},Roguelike.Keyboard.prototype={initialize:function(){var a=this;this._onKeyDown=function(b){return a.processKeyDown(b)},this._onKeyUp=function(b){return a.processKeyUp(b)},window.addEventListener("keydown",this._onKeyDown,!1),window.addEventListener("keyup",this._onKeyUp,!1)},getKey:function(a){return void 0===this.keys[a]&&(this.keys[a]=new Roguelike.Key(a)),this.keys[a]},processKeyDown:function(a){void 0!==this.keys[a.keyCode]&&(a.preventDefault(),this.keys[a.keyCode].processKeyDown(a))},processKeyUp:function(a){void 0!==this.keys[a.keyCode]&&this.keys[a.keyCode].processKeyUp(a)}},Roguelike.Tile=function(a,b,c,d,e){this.type=a,this.tileRow=d,this.tileNumber=e,this.belongsTo=c||null,this.entities=[],this.blockLight=b,this.lightLevel=0,this.explored=!1},Roguelike.Map=function(a){this.game=a,this.entities=null,this.tilesX=a.settings.tilesX,this.tilesY=a.settings.tilesY,this.maxRooms=a.settings.maxRooms,this.rooms=[],this.tiles=[],this.objects=[],this.tileSize=a.settings.tileSize,this.minRoomWidth=a.settings.minRoomWidth,this.maxRoomWidth=a.settings.maxRoomWidth,this.minRoomHeight=a.settings.minRoomHeight,this.maxRoomHeight=a.settings.maxRoomHeight,this.mapFactory=null,this.entrance=null,this.exit=null},Roguelike.Map.prototype={initialize:function(){this.mapFactory=new Roguelike.MapFactory(this.game);for(var a=0;a<this.tilesX;a++){this.tiles[a]=[];for(var b=0;b<this.tilesY;b++)this.tiles[a][b]=new Roguelike.Tile(0,!0,0,0)}},typeList:function(){for(var a=[],b=0;b<this.tilesY;b++){a.push([]);for(var c=0;c<this.tilesX;c++)a[b][c]=this.tiles[c][b].type}return a},roomIntersectsWith:function(a){for(var b=0;b<this.rooms.length;b++)if(a.x1<=this.rooms[b].x2&&a.x2>=this.rooms[b].x1&&a.y1<=this.rooms[b].y2&&a.y2>=this.rooms[b].y1)return!0;return!1},addRooms:function(){for(var a=0;a<this.rooms.length;a++)for(var b=this.rooms[a].x1;b<this.rooms[a].x2;b++)for(var c=this.rooms[a].x2-b-1,d=this.rooms[a].y1;d<this.rooms[a].y2;d++){var e=this.rooms[a].y2-d-1,f=this.rooms[a].layout[c][e];this.tiles[b][d]=f}}},Roguelike.MapFactory=function(a){this.game=a,this.possibleDoorLocations=[]},Roguelike.MapFactory.prototype={generateRooms:function(){for(var a=this.game.map,b=this.game.map.maxRooms+10,c=0;a.rooms.length<a.maxRooms&&!(c>=b);){var d=Roguelike.Utils.randomNumber(a.minRoomWidth,a.maxRoomWidth),e=Roguelike.Utils.randomNumber(a.minRoomHeight,a.maxRoomHeight),f=Roguelike.Utils.randomNumber(1,a.tilesX-d-1),g=Roguelike.Utils.randomNumber(1,a.tilesY-e-1),h=new Roguelike.Room(f,g,d,e);c++,a.roomIntersectsWith(h)||(h.initialize(),h.generateExit(),a.rooms.push(h),c=0)}},generateCorridors:function(){for(var a=this.game.map,b=1;b<a.rooms.length;b++)this.generateCorridor(a.rooms[b],a.rooms[b-1])},generateCorridor:function(a,b){var c={x:a.x1+a.exit.x,y:a.y1+a.exit.y},d={x:b.x1+b.exit.x,y:b.y1+b.exit.y};if(d.x-c.x>0)for(var e=d.x;e>=c.x;e--)this.generateHorizontalCorridor(e,d.y);else for(var e=d.x;e<=c.x;e++)this.generateHorizontalCorridor(e,d.y);if(d.y-c.y>0)for(var e=d.y;e>=c.y;e--)this.generateVerticalCorridor(c.x,e);else for(var e=d.y;e<=c.y;e++)this.generateVerticalCorridor(c.x,e)},generateHorizontalCorridor:function(a,b){var c=this.game.map,d=c.tiles[a][b],e=c.tiles[a][b+1],f=c.tiles[a][b-1];1===d.type&&1===e.type&&1===f.type&&this.possibleDoorLocations.push({x:a,y:b}),this.changeTileToFloor(d),0===e.type&&this.changeTileToWall(e),0===f.type&&this.changeTileToWall(f)},generateVerticalCorridor:function(a,b){var c=this.game.map,d=c.tiles[a][b],e=c.tiles[a+1][b],f=c.tiles[a-1][b];1===d.type&&1===e.type&&1===f.type&&this.possibleDoorLocations.push(new Roguelike.Vector2(a,b)),this.changeTileToFloor(d),0===c.tiles[a+1][b+1].type&&this.changeTileToWall(c.tiles[a+1][b+1]),0===c.tiles[a-1][b-1].type&&this.changeTileToWall(c.tiles[a-1][b-1]),0===c.tiles[a+1][b-1].type&&this.changeTileToWall(c.tiles[a+1][b-1]),0===c.tiles[a-1][b+1].type&&this.changeTileToWall(c.tiles[a-1][b+1])},generateDoors:function(){for(var a=0;a<this.possibleDoorLocations.length;a++){var b=this.possibleDoorLocations[a],c=this.game.map.tiles[b.x-1][b.y],d=this.game.map.tiles[b.x+1][b.y],e=this.game.map.tiles[b.x][b.y-1],f=this.game.map.tiles[b.x][b.y+1],g=Roguelike.Utils.randomNumber(0,100);1===c.type&&1===d.type&&0===e.entities.length&&0===f.entities.length&&2===e.type&&2===f.type&&g>80?this.placeDoor(b,!1):2===c.type&&2===d.type&&0===c.entities.length&&0===d.entities.length&&1===e.type&&1===f.type&&g>60&&this.placeDoor(b,!0)}},placeDoor:function(a,b){var c=this.game.map.tiles[a.x][a.y],d=Roguelike.PropFactory.newDoor(a);b===!0&&(d.components.sprite.number=0,d.components.sprite.row=2),this.game.map.entities.addEntity(d),c.entities.push(d),c.blockLight=!0},placeEntranceExitObjects:function(){var a=Roguelike.Utils.randomNumber(0,this.game.map.rooms.length-2),b=this.game.map.rooms.length-1,c=this.game.map.rooms[a],d=this.game.map.rooms[b],e=c.getRandomPosition(),f=d.getRandomPosition();this.game.map.entrance=e,this.game.map.exit=f;var g=new Roguelike.Entity;g.addComponent(new Roguelike.Components.Position(e)),g.addComponent(new Roguelike.Components.Sprite("tileset",3,1));var h=new Roguelike.Entity;h.addComponent(new Roguelike.Components.Position(f)),h.addComponent(new Roguelike.Components.Sprite("tileset",3,0)),this.game.map.entities.addEntity(g),this.game.map.entities.addEntity(h)},changeTileToFloor:function(a){a.type=2,a.tileRow=3,a.tileNumber=Roguelike.Utils.randomNumber(2,5),a.blockLight=!1},changeTileToWall:function(a){a.type=1,a.tileRow=0,a.tileNumber=Roguelike.Utils.randomNumber(1,2),a.blockLight=!0},decorateDungeon:function(){for(var a=this.game.map,b=0;b<a.tilesX;b++)for(var c=0;c<a.tilesY;c++){if(1===a.tiles[b][c].type){var d=this.game.map.tiles[b-1][c],e=this.game.map.tiles[b+1][c],f=this.game.map.tiles[b][c+1],g=this.game.map.tiles[b][c-1];0===d.type&&2===e.type||0===d.type&&1===e.type&&0===g.type?a.tiles[b][c].tileNumber=3:0===e.type&&2===d.type||0===e.type&&1===d.type&&0===g.type?a.tiles[b][c].tileNumber=4:1===g.type&&1===d.type&&0===e.type?a.tiles[b][c].tileNumber=6:1===g.type&&1===e.type&&0===d.type?a.tiles[b][c].tileNumber=5:2===g.type&&1===f.type&&2===d.type&&1===e.type?(a.tiles[b][c].tileRow=1,a.tiles[b][c].tileNumber=3):2===g.type&&1===f.type&&1===d.type&&2===e.type?(a.tiles[b][c].tileRow=1,a.tiles[b][c].tileNumber=2):2===g.type&&1===f.type&&2===d.type&&2===e.type?(a.tiles[b][c].tileRow=1,a.tiles[b][c].tileNumber=5):(1===g.type&&1===f.type&&2===d.type&&2===e.type||1===g.type&&1===f.type&&2===d.type&&1===e.type)&&(a.tiles[b][c].tileRow=1,a.tiles[b][c].tileNumber=4)}2===a.tiles[b][c].type&&(Roguelike.Utils.randomNumber(0,100)>=80&&(grassEntity=new Roguelike.DecorationFactory.newGrass(new Roguelike.Vector2(b,c)),a.tiles[b][c].entities.push(grassEntity),a.entities.addEntity(grassEntity)),Roguelike.Utils.randomNumber(0,100)>=100&&(enemyEntity=new Roguelike.EnemyFactory.newSkeleton(new Roguelike.Vector2(b,c)),a.tiles[b][c].entities.push(enemyEntity),a.entities.addEntity(enemyEntity)))}}},Roguelike.Room=function(a,b,c,d){this.x1=a,this.x2=c+a,this.y1=b,this.y2=b+d,this.w=c,this.h=d,this.layout=[],this.exit=null},Roguelike.Room.prototype={initialize:function(){for(var a=0;a<this.w;a++){this.layout[a]=[];for(var b=0;b<this.h;b++)this.layout[a][b]=0===b||b===this.h-1||0===a||a===this.w-1?new Roguelike.Tile(1,!0,this,0,Roguelike.Utils.randomNumber(1,2)):new Roguelike.Tile(2,!1,this,3,2)}},generateExit:function(){switch(Roguelike.Utils.randomNumber(1,4)){case 1:this.exit={x:Roguelike.Utils.randomNumber(1,this.w-2),y:this.h-2};break;case 2:this.exit={x:Roguelike.Utils.randomNumber(1,this.w-2),y:1};break;case 3:this.exit={x:this.w-2,y:Roguelike.Utils.randomNumber(1,this.h-2)};break;case 4:this.exit={x:1,y:Roguelike.Utils.randomNumber(1,this.h-2)}}},getRandomPosition:function(){var a=Roguelike.Utils.randomNumber(2,this.w-3),b=Roguelike.Utils.randomNumber(2,this.h-3);return a+=this.x1,b+=this.y1,new Roguelike.Vector2(a,b)}};var EasyStar=EasyStar||{};EasyStar.Node=function(a,b,c,d,e){this.parent=a,this.x=b,this.y=c,this.costSoFar=d,this.simpleDistanceToTarget=e,this.bestGuessDistance=function(){return this.costSoFar+this.simpleDistanceToTarget}},EasyStar.Node.OPEN_LIST=0,EasyStar.Node.CLOSED_LIST=1,EasyStar.PriorityQueue=function(a,b){this.length=0;var c=[],d=!1;if(b==EasyStar.PriorityQueue.MAX_HEAP)d=!0;else{if(b!=EasyStar.PriorityQueue.MIN_HEAP)throw b+" not supported.";d=!1}this.insert=function(b){if(!b.hasOwnProperty(a))throw"Cannot insert "+b+" because it does not have a property by the name of "+a+".";c.push(b),this.length++,e(this.length-1)},this.getHighestPriorityElement=function(){return c[0]},this.shiftHighestPriorityElement=function(){if(0===this.length)throw"There are no more elements in your priority queue.";if(1===this.length){var a=c[0];return c=[],this.length=0,a}var b=c[0],d=c.pop();return this.length--,c[0]=d,f(0),b};var e=function(a){if(0!==a){var b=i(a);h(a,b)&&(g(a,b),e(b))}},f=function(a){if(left=j(a),right=k(a),h(left,a))g(a,left),f(left);else if(h(right,a))g(a,right),f(right);else{if(0==a)return;f(0)}},g=function(a,b){var d=c[a];c[a]=c[b],c[b]=d},h=function(b,e){return void 0===c[e]||void 0===c[b]?!1:("function"==typeof c[b][a]?(selfValue=c[b][a](),targetValue=c[e][a]()):(selfValue=c[b][a],targetValue=c[e][a]),d?selfValue>targetValue?!0:!1:targetValue>selfValue?!0:!1)},i=function(a){return Math.floor(a/2)-1},j=function(a){return 2*a+1},k=function(a){return 2*a+2}},EasyStar.PriorityQueue.MAX_HEAP=0,EasyStar.PriorityQueue.MIN_HEAP=1,EasyStar.instance=function(){this.isDoneCalculating=!0,this.pointsToAvoid={},this.startX,this.callback,this.startY,this.endX,this.endY,this.nodeHash={},this.openList},EasyStar.js=function(){var a,b,c,d=10,e=14,f={},g={},h=[],i=Number.MAX_VALUE,j=!1;this.setAcceptableTiles=function(a){a instanceof Array?c=a:!isNaN(parseFloat(a))&&isFinite(a)&&(c=[a])},this.enableDiagonals=function(){j=!0},this.disableDiagonals=function(){j=!1},this.setGrid=function(b){a=b;for(var c=0;c<a.length;c++)for(var d=0;d<a[0].length;d++)g[a[c][d]]||(g[a[c][d]]=1)},this.setTileCost=function(a,b){g[a]=b},this.setIterationsPerCalculation=function(a){i=a},this.avoidAdditionalPoint=function(a,b){f[a+"_"+b]=1},this.stopAvoidingAdditionalPoint=function(a,b){delete f[a+"_"+b]},this.stopAvoidingAllAdditionalPoints=function(){f={}},this.findPath=function(b,e,f,g,i){if(void 0===c)throw"You can't set a path without first calling setAcceptableTiles() on EasyStar.";if(void 0===a)throw"You can't set a path without first calling setGrid() on EasyStar.";if(0>b||0>e||0>f||0>f||b>a[0].length-1||e>a.length-1||f>a[0].length-1||g>a.length-1)throw"Your start or end point is outside the scope of your grid.";b===f&&e===g&&i([]);for(var j=a[g][f],k=!1,m=0;m<c.length;m++)if(j===c[m]){k=!0;break}if(k===!1)return void i(null);var n=new EasyStar.instance;n.openList=new EasyStar.PriorityQueue("bestGuessDistance",EasyStar.PriorityQueue.MIN_HEAP),n.isDoneCalculating=!1,n.nodeHash={},n.startX=b,n.startY=e,n.endX=f,n.endY=g,n.callback=i,n.openList.insert(l(n,n.startX,n.startY,null,d)),h.push(n)},this.calculate=function(){if(0!==h.length&&void 0!==a&&void 0!==c)for(b=0;i>b;b++){if(0===h.length)return;if(0!==h[0].openList.length){var f=h[0].openList.shiftHighestPriorityElement();if(f.list=EasyStar.Node.CLOSED_LIST,f.y>0&&(k(h[0],f,0,-1,d*g[a[f.y-1][f.x]]),h[0].isDoneCalculating===!0))h.shift();else if(f.x<a[0].length-1&&(k(h[0],f,1,0,d*g[a[f.y][f.x+1]]),h[0].isDoneCalculating===!0))h.shift();else if(f.y<a.length-1&&(k(h[0],f,0,1,d*g[a[f.y+1][f.x]]),h[0].isDoneCalculating===!0))h.shift();else if(f.x>0&&(k(h[0],f,-1,0,d*g[a[f.y][f.x-1]]),h[0].isDoneCalculating===!0))h.shift();else if(j){if(f.x>0&&f.y>0&&(k(h[0],f,-1,-1,e*g[a[f.y-1][f.x-1]]),h[0].isDoneCalculating===!0)){h.shift();continue}if(f.x<a[0].length-1&&f.y<a.length-1&&(k(h[0],f,1,1,e*g[a[f.y+1][f.x+1]]),h[0].isDoneCalculating===!0)){h.shift();continue}if(f.x<a[0].length-1&&f.y>0&&(k(h[0],f,1,-1,e*g[a[f.y-1][f.x+1]]),h[0].isDoneCalculating===!0)){h.shift();continue}if(f.x>0&&f.y<a.length-1&&(k(h[0],f,-1,1,e*g[a[f.y+1][f.x-1]]),h[0].isDoneCalculating===!0)){h.shift();continue}}}else h[0].callback(null),h.shift()}};var k=function(b,d,e,g,h){var i=d.x+e,j=d.y+g;if(b.endX===i&&b.endY===j){b.isDoneCalculating=!0;var k=[],m=0;k[m]={x:i,y:j},m++,k[m]={x:d.x,y:d.y},m++;for(var n=d.parent;null!=n;)k[m]={x:n.x,y:n.y},m++,n=n.parent;k.reverse(),b.callback(k)}if(void 0===f[i+"_"+j])for(var o=0;o<c.length;o++)if(a[j][i]===c[o]){var p=l(b,i,j,d,h);void 0===p.list?(p.list=EasyStar.Node.OPEN_LIST,b.openList.insert(p)):p.list===EasyStar.Node.OPEN_LIST&&d.costSoFar+h<p.costSoFar&&(p.costSoFar=d.costSoFar+h,p.parent=d);break}},l=function(a,b,c,d,e){if(void 0!==a.nodeHash[b+"_"+c])return a.nodeHash[b+"_"+c];var f=m(b,c,a.endX,a.endY);if(null!==d)var g=d.costSoFar+e;else g=f;var h=new EasyStar.Node(d,b,c,g,f);return a.nodeHash[b+"_"+c]=h,h},m=function(a,b,c,d){return Math.floor(Math.abs(b-a)+Math.abs(d-c))}},"function"==typeof define&&define.amd&&define("easystar",[],function(){return EasyStar}),window.onload=function(){initializeCanvas()};